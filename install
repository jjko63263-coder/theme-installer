#!/bin/bash

clear

# Colors
RED='\033[0;31m'
GRN='\033[0;32m'
CYN='\033[0;36m'
YEL='\033[1;33m'
NC='\033[0m' # No Color

# ASCII Art Banner: SHIVAM
echo -e "${YEL}"
cat << "EOF"
  ____  _    ___  __     __  _    _ 
 / ___|| |  |_ _| \ \   / / | |  | |
| |    | |   | |   \ \ / /  | |__| |
| |    | |   | |    \ V /   |  __  |
| |___ | |___| |     | |    | |  | |
 \____||_____|___|    |_|    |_|  |_|
EOF
echo -e "${NC}"

# Subscribe animation
echo -ne "${GRN}üî• Please Subscribe \n"
for i in {1..3}; do
  echo -ne "${CYN}Subscribing To SHIVAM"
  for dot in {1..3}; do
    echo -n "."
    sleep 0.3
  done
  echo -ne "\r                     \r"
done
echo -e "${GRN} Thanks for Subscribing! If Not Do It Rn${NC}\n"
sleep 1

# -------------------------------------------------------
# Update system and install Docker Compose
# -------------------------------------------------------
echo -e "${YEL}X-> Installing Docker & Docker Compose...${NC}"
apt update && apt upgrade -y
apt install -y docker-compose software-properties-common curl apt-transport-https ca-certificates gnupg lsb-release

# -------------------------------------------------------
# Add PHP repo & Redis repo
# -------------------------------------------------------
echo -e "${YEL}X-> Adding PHP and Redis repositories...${NC}"
LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php
curl -fsSL https://packages.redis.io/gpg | gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/redis.list

# -------------------------------------------------------
# Install required packages
# -------------------------------------------------------
echo -e "${YEL}X-> Installing PHP, MariaDB, Nginx, Redis, Composer...${NC}"
apt update
apt -y install php8.1 php8.1-{cli,gd,mysql,pdo,mbstring,tokenizer,bcmath,xml,fpm,curl,zip} \
               mariadb-server nginx tar unzip git redis
curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# -------------------------------------------------------
# Setup Jexactyl panel
# -------------------------------------------------------
echo -e "${CYN}X-> Setting up JEXACTYL Panel directories...${NC}"
mkdir -p /var/www/jexactyl
cd /var/www/jexactyl || exit

echo -e "${CYN}X-> Downloading panel...${NC}"
curl -Lo panel.tar.gz https://github.com/jexactyl/jexactyl/releases/latest/download/panel.tar.gz
tar -xzvf panel.tar.gz
chmod -R 755 storage/* bootstrap/cache/

# -------------------------------------------------------
# Database setup instructions
# -------------------------------------------------------
echo -e "${CYN}X-> Database setup...${NC}"
echo -e "${RED}‚ö†Ô∏è You need to set up MySQL manually. Run:${NC}"
echo "   mysql -u root -p"
echo "   CREATE USER 'jexactyl'@'127.0.0.1' IDENTIFIED BY 'root';"
echo "   CREATE DATABASE panel;"
echo "   GRANT ALL PRIVILEGES ON panel.* TO 'jexactyl'@'127.0.0.1' WITH GRANT OPTION;"
echo "   exit"

# -------------------------------------------------------
# Laravel setup
# -------------------------------------------------------
cp .env.example .env
composer install --no-dev --optimize-autoloader
php artisan key:generate --force

php artisan p:environment:setup
php artisan p:environment:database
php artisan migrate --seed --force
php artisan p:user:make

echo -e "${YEL}‚úÖ Successfully completed installation! Next: configure Nginx & SSL.${NC}"
